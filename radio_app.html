<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Melvex App</title>
    <!-- Carga de Tailwind CSS para el diseño móvil y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIBRERÍA HLS.JS: Necesaria para reproducir streams avanzados como .m3u8 (HLS) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Referencia al Manifiesto de la PWA -->
    <link rel="manifest" href="./manifest.json">
    <style>
        /* Estilos personalizados para el slider de volumen (Track/Rail) */
        input[type=range]::-webkit-slider-runnable-track {
            background: #4b5563;
            height: 8px;
            border-radius: 4px;
        }
        input[type=range]::-moz-range-track {
            background: #4b5563;
            height: 8px;
            border-radius: 4px;
        }
        /* Estilos personalizados para el control deslizante (Thumb) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            margin-top: -4px; /* Centra el thumb con el track */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Estilo para el spin de carga */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">

    <div class="p-4 sm:p-6 max-w-lg mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-teal-400">Radio Melvex App</h1>
            <p class="text-gray-400">Tu reproductor de streams favorito.</p>
        </header>

        <!-- Sección de Reproducción Actual -->
        <div id="player-card" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 id="current-station" class="text-xl font-bold truncate">Selecciona una emisora</h2>
                <div id="loading-indicator" class="loader hidden"></div>
            </div>
            
            <!-- Carátula y Nombre de Canción -->
            <div class="flex flex-col items-center mb-6">
                <img id="song-art" src="https://placehold.co/120x120/0f172a/94a3b8?text=NO+IMAGE" 
                     alt="Carátula de la canción" 
                     class="w-32 h-32 rounded-lg object-cover mb-4 shadow-lg">
                <p id="song-text" class="text-center text-gray-300 text-sm italic">Información de la canción...</p>
            </div>

            <div class="flex justify-center mb-6">
                <button id="play-pause-button" class="bg-teal-600 hover:bg-teal-500 text-white p-4 rounded-full shadow-lg transition duration-200 disabled:opacity-50" disabled>
                    <!-- Icono de Play (predeterminado) -->
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <!-- Icono de Pausa (se muestra al reproducir) -->
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>

            <!-- Control de Volumen -->
            <div class="flex items-center space-x-3 text-gray-400">
                <!-- Icono de Volumen -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.476 2.476a8 8 0 000-12.024m-4.502 4.502a2 2 0 010 2.828M15 12H9m0 0l2-2m-2 2l2 2" />
                </svg>
                <input type="range" id="volumeRange" min="0" max="100" value="70" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <span id="volume-display" class="w-10 text-right">70%</span>
            </div>
        </div>

        <!-- Lista de Emisoras -->
        <h2 class="2xl font-bold mb-4 text-teal-400">Emisoras Disponibles</h2>
        <div id="stations-list" class="space-y-3 mb-8">
            <!-- Las emisoras se inyectan aquí por JavaScript -->
        </div>
        
        <!-- Sección de Stream Personalizado (MOVEMOS AL FINAL) -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-3 text-teal-400">Añadir Stream Personalizado</h3>
            <p class="text-gray-400 text-sm mb-4">
                Pega la URL directa de un stream de audio (.mp3, .m3u8, etc.). 
                Puedes encontrar streams buscando en sitios como: 
                <a href="https://fmstream.org/index.php?c=E&o=top" target="_blank" class="text-indigo-400 hover:text-indigo-300 underline">fmstream.org</a>.
            </p>
            <div class="flex flex-col space-y-3">
                <input type="text" id="customUrlInput" placeholder="Pega aquí la URL de stream" 
                       class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-teal-500 focus:border-teal-500 border-none">
                <button id="loadCustomUrlButton" 
                        class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-md transition duration-200">
                    Cargar y Reproducir
                </button>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>
    
    <!-- Footer con la hora de actualización -->
    <footer class="mt-8 mb-4 p-4">
        <p id="update-time-text" class="text-xs text-gray-500 text-center"></p>
    </footer>

    <script>
        // --- INFORMACIÓN DE LA ÚLTIMA VERSIÓN ---
        // DEBES ACTUALIZAR ESTA VARIABLE CADA VEZ QUE HAGAS UN COMMIT IMPORTANTE.
        const LAST_UPDATE_TIME = "23 Nov 2025, 20:42 UTC"; 

        // Definición de las emisoras con su URL de stream y su ID de API (si existe)
        const STATIONS = [
            // 1. Onda Cero (Primera)
            { name: "Onda Cero España", url: "https://atres-live.ondacero.es/live/ondacero/bitrate_1.m3u8", api_id: null },
            { name: "Onda Cero España", url: "https://atres-live.ondacero.es/live/ondaceroeventos1/bitrate_1.m3u8", api_id: null },
            //https://atres-live.ondacero.es/live/ondaceroeventos1/bitrate_1.m3u8
            // 2. Emisoras LocaFM (Agrupadas)
            { name: "LocaFM Live", url: "https://go-audio.toya.net.pl/175", api_id: null },
            { name: "LocaFM BigRoom", url: "https://s2.we4stream.com/listen/loca_big_room/live", api_id: "loca_big_room" },
            { name: "LocaFM House", url: "https://s2.we4stream.com/listen/loca_house/live", api_id: "loca_house" },
            { name: "LocaFM Mola", url: "https://s02.fjperezdj.com:8070/live", api_id: "loca_mola" },

            // 3. Resto de Emisoras
            { name: "RockFM", url: "https://rockfm-cope-rrcast.flumotion.com/cope/rockfm.mp3", api_id: null },
            { name: "Radio 5", url: "https://rtvelivestream.rtve.es/rtvesec/rne/rne_r5_madrid_main.m3u8", api_id: null },
            { name: "Radio 3", url: "https://ztnr.rtve.es/ztnr/2795617.m3u8", api_id: null },
            
            // Ejemplos SomaFM
            { name: "Beat Blender (SomaFM)", url: "http://ice1.somafm.com/beatblender-128-mp3", api_id: null },
            { name: "Groove Salad (SomaFM)", url: "http://ice1.somafm.com/groovesalad-128-mp3", api_id: null },
            { name: "DEF CON Radio (SomaFM)", url: "http://ice1.somafm.com/defcon-128-mp3", api_id: null },
            { name: "Illinois Street Lounge (SomaFM)", url: "http://ice1.somafm.com/illstreet-128-aac", api_id: null },
        ];

        let currentStation = null;
        let updateInterval = null; // Variable para almacenar el ID del intervalo de actualización
        const audio = document.getElementById('audio-player');
        const playPauseButton = document.getElementById('play-pause-button');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const currentStationDisplay = document.getElementById('current-station');
        const volumeRange = document.getElementById('volumeRange');
        const volumeDisplay = document.getElementById('volume-display');
        const customUrlInput = document.getElementById('customUrlInput');
        const loadCustomUrlButton = document.getElementById('loadCustomUrlButton');
        const loadingIndicator = document.getElementById('loading-indicator');
        const songTextElement = document.getElementById('song-text');
        const songArtElement = document.getElementById('song-art');

        // URL de la imagen de reemplazo (placeholder)
        const DEFAULT_ART_URL = 'https://placehold.co/120x120/0f172a/94a3b8?text=RADIO+STREAM';
        
        // Cadenas de texto genéricas que queremos ignorar
        const GENERIC_TEXT = [
            'stream online', 'radio live', 'playing now', 'loca fm', 'no title', 'loading', 'stream'
        ];
        
        // Almacena la instancia de HLS para poder destruirla si cambiamos de estación
        let hlsInstance = null; 

        // --- Lógica de Now Playing (Canción Actual) ---

        /**
         * Actualiza el nombre de la canción y la carátula usando la API de la emisora.
         */
        async function updateNowPlaying() {
            if (!currentStation || !currentStation.api_id) {
                // Si la emisora no tiene API, muestra un mensaje limpio.
                songTextElement.textContent = 'Información de la canción no disponible.';
                songArtElement.src = DEFAULT_ART_URL;
                return;
            }

            try {
                // Se asume que todas las APIs de LocaFM usan la misma base
                const apiUrl = `https://s2.we4stream.com/api/nowplaying/${currentStation.api_id}`;
                
                const maxRetries = 3;
                let response = null;

                // Implementar backoff exponencial para el fetch
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(apiUrl);
                        if (response.ok) break;
                    } catch (error) {
                        // Espera con backoff exponencial
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error("Respuesta de API no válida después de reintentos.");
                }

                const data = await response.json();
                const song = data.now_playing.song;
                
                // ----------------------------------------------------
                // 1. Lógica de Limpieza y Fallback del Título (Texto)
                // ----------------------------------------------------
                let songText = song.text || (song.artist && song.title ? `${song.artist} - ${song.title}` : null);
                
                // Sanitización: Convertir a minúsculas para chequear texto genérico
                if (songText) {
                    const lowerText = songText.toLowerCase().trim();
                    const isGeneric = GENERIC_TEXT.some(generic => lowerText.includes(generic));
                    
                    if (isGeneric || lowerText.length < 5) {
                        songText = null; // Ignorar texto genérico o demasiado corto
                    }
                }

                // Aplicar el resultado al elemento
                if (songText) {
                    songTextElement.textContent = songText;
                } else {
                    songTextElement.textContent = 'Actualmente sonando: Música...';
                }
                
                // ----------------------------------------------------
                // 2. Lógica de Limpieza y Fallback de la Carátula (Arte)
                // ----------------------------------------------------
                let artUrl = DEFAULT_ART_URL;
                if (song.art && typeof song.art === 'string' && song.art.startsWith('http')) {
                    // Solo usar la URL si es un string que parece ser una URL http(s)
                    artUrl = song.art;
                }

                songArtElement.src = artUrl;


            } catch (err) {
                console.error('Error al obtener now playing:', err);
                songTextElement.textContent = 'Error de conexión con la información de la canción.';
                songArtElement.src = DEFAULT_ART_URL;
            }
        }


        // --- Lógica Principal del Reproductor ---

        /**
         * Maneja la reproducción o pausa del audio.
         */
        function togglePlayPause() {
            if (audio.paused) {
                // Necesitamos el "user gesture" (clic del usuario) para iniciar la reproducción
                // y evitar que el navegador lo bloquee.
                audio.play().catch(error => {
                    console.error("Error al intentar reproducir:", error);
                    alertMessage('Error de reproducción', 'El navegador bloqueó la reproducción automática. Intenta de nuevo.');
                    // Si falla, volvemos a pausado
                    updateUI(false); 
                });
            } else {
                audio.pause();
            }
            // La UI se actualizará automáticamente con los eventos 'play' y 'pause'
        }

        /**
         * Reproduce una emisora específica.
         * @param {Object} station - Objeto de la emisora (name, url, api_id)
         */
        function playStation(station) {
            // Limpiar intervalo anterior de Now Playing
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            // 1. Limpieza y manejo de HLS.js
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }
            audio.src = ''; // Limpiamos el src nativo por seguridad
            
            currentStation = station;
            currentStationDisplay.textContent = station.name;
            playPauseButton.disabled = false;
            
            const streamUrl = station.url;
            // Usar una expresión más simple para detectar m3u/m3u8/pls
            const isHLS = streamUrl.toLowerCase().includes('.m3u8') || streamUrl.toLowerCase().includes('.m3u') || streamUrl.toLowerCase().includes('.pls');


            if (Hls.isSupported() && isHLS) {
                // Usar HLS.js para streams HLS/m3u8
                hlsInstance = new Hls();
                hlsInstance.attachMedia(audio);
                hlsInstance.on(Hls.Events.MEDIA_ATTACHED, function () {
                    hlsInstance.loadSource(streamUrl);
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                        togglePlayPause();
                    });
                });
                hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                    console.error("HLS Error:", data.type, data.details);
                    if (data.fatal) {
                         alertMessage('Error HLS', 'El stream no se pudo cargar. Puede ser un problema de CORS o el enlace está roto.');
                         updateUI(false);
                    }
                });

            } else if (isHLS) {
                // Fallback si HLS no está soportado (aunque casi siempre lo está)
                alertMessage('Error', 'HLS.js no está soportado. Intentando con reproductor nativo...');
                audio.src = streamUrl;
                togglePlayPause();

            } else {
                // Usar reproductor nativo para MP3, AAC, etc.
                audio.src = streamUrl;
                togglePlayPause();
            }

            // Si tiene API, iniciar la actualización de Now Playing
            if (station.api_id) {
                updateNowPlaying();
                updateInterval = setInterval(updateNowPlaying, 15000); // Actualiza cada 15 segundos
            } else {
                // Si no hay API, usar fallback limpio
                songTextElement.textContent = 'Información de la canción no disponible.';
                songArtElement.src = DEFAULT_ART_URL;
            }

            // Guardar la última estación seleccionada en localStorage
            localStorage.setItem('lastStation', JSON.stringify(station));

            // Actualizar la lista para resaltar la activa
            renderStations();
        }

        /**
         * Genera los botones de las emisoras en el HTML.
         */
        function renderStations() {
            const list = document.getElementById('stations-list');
            list.innerHTML = ''; // Limpiar la lista
            
            STATIONS.forEach(station => {
                const isActive = currentStation && currentStation.url === station.url;
                const button = document.createElement('button');
                button.textContent = station.name;
                button.className = `w-full text-left p-4 rounded-xl font-semibold shadow-md transition duration-200 
                                     ${isActive ? 'bg-teal-600 hover:bg-teal-500' : 'bg-gray-700 hover:bg-gray-600'}`;
                button.onclick = () => playStation(station);
                list.appendChild(button);
            });
        }

        /**
         * Actualiza el estado visual de la UI (botones, iconos, indicador de carga).
         * @param {boolean} isPlaying - Verdadero si el audio se está reproduciendo.
         */
        function updateUI(isPlaying) {
            if (isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Maneja el cambio de volumen.
         */
        function handleVolumeChange() {
            const volumeValue = volumeRange.value;
            const audioVolume = volumeValue / 100;
            audio.volume = audioVolume;
            volumeDisplay.textContent = `${volumeValue}%`;
            // Guardar volumen en localStorage
            localStorage.setItem('audioVolume', volumeValue);
        }

        /**
         * Muestra un mensaje modal en lugar de alert().
         * @param {string} title - Título del mensaje.
         * @param {string} message - Contenido del mensaje.
         */
        function alertMessage(title, message) {
            // Implementación simple de un modal de mensaje en la consola
            console.warn(`${title}: ${message}`);
            // NOTA: En una app real, aquí se mostraría un modal visible al usuario.
        }

        /**
         * Inicializa la aplicación, carga la última configuración y registra eventos.
         */
        function initializeApp() {
            // 0. Mostrar fecha de actualización
            document.getElementById('update-time-text').textContent = `Última modificación del código: ${LAST_UPDATE_TIME}`;

            // 1. Inicializar Volumen
            const savedVolume = localStorage.getItem('audioVolume') || 70;
            volumeRange.value = savedVolume;
            handleVolumeChange(); // Aplica el volumen inicial
            volumeRange.addEventListener('input', handleVolumeChange);

            // 2. Inicializar Eventos del Reproductor
            playPauseButton.addEventListener('click', togglePlayPause);
            
            // Eventos del Audio API
            audio.addEventListener('play', () => updateUI(true));
            audio.addEventListener('pause', () => updateUI(false));
            audio.addEventListener('waiting', () => {
                loadingIndicator.classList.remove('hidden');
                songTextElement.textContent = 'Cargando stream...';
            });
            audio.addEventListener('stalled', () => {
                loadingIndicator.classList.remove('hidden');
                songTextElement.textContent = 'Conexión interrumpida, reintentando...';
            });
            audio.addEventListener('playing', () => {
                loadingIndicator.classList.add('hidden');
                // Al empezar a sonar, aseguramos que el texto de la canción se actualice
                if (!currentStation || !currentStation.api_id) {
                     songTextElement.textContent = 'Reproduciendo ' + (currentStation ? currentStation.name : 'Stream');
                } else {
                    // Si tiene API, hacemos una actualización inmediata al empezar a sonar
                    updateNowPlaying(); 
                }
            });
            audio.addEventListener('error', (e) => {
                loadingIndicator.classList.add('hidden');
                updateUI(false);
                console.error("Error de Audio:", e);
                alertMessage('Error Crítico', 'No se pudo reproducir el stream. El enlace puede estar roto o es incompatible.');
            });


            // 3. Inicializar Lista de Emisoras
            renderStations();

            // 4. Inicializar Stream Personalizado
            loadCustomUrlButton.addEventListener('click', () => {
                const customUrl = customUrlInput.value.trim();
                if (customUrl) {
                    const customStation = { 
                        name: "Stream Personalizado", 
                        url: customUrl, 
                        api_id: null // No hay API de Now Playing para streams arbitrarios
                    };
                    playStation(customStation);
                } else {
                    alertMessage('URL Requerida', 'Por favor, introduce una URL de stream válida.');
                }
            });
            customUrlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    loadCustomUrlButton.click();
                }
            });

            // 5. Cargar última estación (si existe)
            const lastStation = localStorage.getItem('lastStation');
            if (lastStation) {
                try {
                    const station = JSON.parse(lastStation);
                    // Validar si la estación guardada es una de las predefinidas, si no, se carga
                    const predefined = STATIONS.find(s => s.url === station.url);
                    currentStation = predefined || station; 
                    currentStationDisplay.textContent = currentStation.name;
                    playStation(currentStation); 
                } catch (e) {
                    console.error("Error al parsear la última estación guardada:", e);
                }
            }
        }
        
        // Ejecutar la inicialización al cargar la página
        initializeApp();

        // --- Registro del Service Worker (Fundamental para la PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Registrar el service worker en el mismo directorio
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registrado con éxito:', reg.scope))
                    .catch(err => console.error('Error al registrar Service Worker:', err));
            });
        }
    </script>
</body>
</html>

