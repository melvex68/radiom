<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio App Móvil</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Aplicar la fuente Inter y un fondo oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Gris oscuro */
        }
        /* Estilo para el contenedor principal centrado */
        #app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        /* Estilo para el botón principal de play/pausa */
        #playPauseButton {
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Estilo para los botones de emisoras */
        .station-button {
            transition: background-color 0.2s;
        }
        .station-button:hover {
            background-color: #4b5563; /* Gris más claro en hover */
        }
        /* Estilo personalizado para el slider de volumen */
        #volumeRange {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #4b5563; /* Color de pista gris */
            cursor: pointer;
            width: 100%;
        }
        /* Estilo para el 'pulgar' del slider en Chrome/Safari */
        #volumeRange::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981; /* Color teal vibrante */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.7);
        }
        /* Estilo para el 'pulgar' del slider en Firefox */
        #volumeRange::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.7);
        }
        /* Animación para el estado de carga/buffer */
        @keyframes pulse-teal {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #047857; }
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            margin: 0 4px;
            animation: pulse-teal 1.5s infinite ease-in-out;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.3s; }
        .loading-dot:nth-child(3) { animation-delay: 0.6s; }
    </style>
</head>
<body>
    <div id="app-container" class="max-w-md mx-auto w-full">

        <header class="text-center py-6">
            <h1 class="text-4xl font-extrabold text-white">
                Radio Móvil
            </h1>
            <p class="text-gray-400 mt-2">Tu música en cualquier lugar</p>
        </header>

        <section class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-lg font-semibold text-teal-400 mb-2">Emisora Actual:</h2>
            <div id="station-info" class="text-2xl font-bold text-white min-h-[3rem]">
                Selecciona una emisora
            </div>
            <div id="status-display" class="mt-2 min-h-[1.5rem]">
                <p id="status-message" class="text-sm text-gray-400">Detenido.</p>
                <div id="loading-indicator" class="flex justify-start items-center space-x-2 mt-1 hidden">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <span class="text-sm text-teal-400 font-semibold">Cargando...</span>
                </div>
            </div>

            <div class="flex items-center space-x-3 mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.383 5.483A1 1 0 0110 6v8a1 1 0 01-1.617.75l-4-3.25H3a1 1 0 01-1-1V8a1 1 0 011-1h1.767l4-3.25a1 1 0 01.616-.267zM15.586 11H14a1 1 0 110-2h1.586l.707-.707a1 1 0 011.414 1.414l-1.414 1.414z" clip-rule="evenodd" />
                </svg>
                <input type="range" id="volumeRange" min="0" max="100" value="70" class="flex-grow">
                <span id="volume-display" class="text-white text-sm w-8 text-right">70%</span>
            </div>
        </section>

        <div class="flex justify-center mb-10">
            <button id="playPauseButton"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 px-12 rounded-full text-xl shadow-lg transform transition-all active:scale-95 flex items-center space-x-2">
                <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <span id="buttonText">Reproducir</span>
            </button>
        </div>
        
        <section class="bg-gray-700 p-4 rounded-xl shadow-inner mb-6">
            <h2 class="text-lg font-bold text-white mb-3">Añadir Stream Personalizado</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <input type="url" id="customUrlInput" 
                        placeholder="Pega aquí la URL (ej. http://stream.mp3)" 
                        class="flex-grow p-3 rounded-lg bg-gray-600 text-white border border-gray-500 focus:ring-teal-500 focus:border-teal-500" 
                        required>
                <button id="loadCustomUrlButton" 
                        class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg active:scale-95 transition">
                    Cargar y Reproducir
                </button>
            </div>
        </section>
        
        <section class="flex-grow">
            <h2 class="text-xl font-bold text-white mb-4">Emisoras Disponibles</h2>
            <div id="station-list" class="space-y-3">
            </div>
        </section>

        <audio id="radio-audio" class="hidden" preload="none"></audio>
    </div>

    <script>
        // --- Constantes y Variables Globales ---
        const STATIONS = [
            // Emisoras añadidas por el usuario
            { name: "Onda Cero España", url: "https://atres-live.ondacero.es/live/ondacero/bitrate_1.m3u8" },
            { name: "LocaFM House", url: "https://s2.we4stream.com/listen/loca_house/live" },
            { name: "LocaFM Mola", url: "https://s02.fjperezdj.com:8070/live" },
            { name: "Beat Blender (Deep House)", url: "http://ice1.somafm.com/beatblender-128-mp3" },
            { name: "Groove Salad (Chill Downtempo)", url: "http://ice1.somafm.com/groovesalad-128-mp3" },
            { name: "DEF CON Radio (Música Hacking)", url: "http://ice1.somafm.com/defcon-128-mp3" },
            { name: "Illinois Street Lounge (Exótica)", url: "http://ice1.somafm.com/illstreet-128-aac" }
        ];

        let currentStation = null;
        let isPlaying = false;
        
        // Referencias al DOM
        const audio = document.getElementById('radio-audio');
        const stationListDiv = document.getElementById('station-list');
        const playPauseButton = document.getElementById('playPauseButton');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const buttonText = document.getElementById('buttonText');
        const stationInfo = document.getElementById('station-info');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Nuevas referencias para el control de volumen y URL personalizada
        const volumeRange = document.getElementById('volumeRange');
        const volumeDisplay = document.getElementById('volume-display');
        const customUrlInput = document.getElementById('customUrlInput');
        const loadCustomUrlButton = document.getElementById('loadCustomUrlButton');


        // --- Funciones de Utilidad y UI ---

        /**
         * Muestra u oculta el indicador de carga visual.
         * @param {boolean} show - true para mostrar, false para ocultar.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
                statusMessage.classList.add('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                statusMessage.classList.remove('hidden');
            }
        }

        /**
         * Actualiza el estado visual del botón principal y el mensaje.
         * @param {boolean} playing - true si está reproduciendo, false si está detenido/pausado.
         */
        function updateUI(playing) {
            isPlaying = playing;
            if (playing) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                buttonText.textContent = 'Detener';
                // Cambiar color a rojo cuando está sonando
                playPauseButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                playPauseButton.classList.add('bg-red-600', 'hover:bg-red-700');
                statusMessage.textContent = `Reproduciendo: ${currentStation.name}`;
                showLoading(false);
            } else {
                pauseIcon.classList.add('hidden');
                playIcon.classList.remove('hidden');
                buttonText.textContent = 'Reproducir';
                // Volver a color índigo cuando está detenido
                playPauseButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                playPauseButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                statusMessage.textContent = currentStation ? `Detenido en ${currentStation.name}` : 'Selecciona una emisora';
                showLoading(false);
            }
        }

        /**
         * Maneja la lógica de reproducción de una emisora específica.
         * @param {object} station - El objeto de la emisora {name, url}.
         */
        async function playStation(station) {
            // Detener la reproducción anterior si existe
            audio.pause();

            // Configurar la nueva emisora
            currentStation = station;
            stationInfo.textContent = currentStation.name;
            audio.src = currentStation.url;
            
            showLoading(true);
            statusMessage.textContent = ''; // Ocultar mensaje de estado mientras carga
            
            // Intentar reproducir (requiere interacción del usuario en la mayoría de los móviles)
            try {
                // El método .load() es importante para refrescar el stream
                audio.load(); 
                await audio.play();
                // El evento 'playing' actualizará la UI a 'true'
            } catch (error) {
                // Manejar errores de permisos o de carga
                console.error("Error al intentar reproducir:", error);
                statusMessage.textContent = `Error: Debes hacer clic en Reproducir o la URL es incorrecta.`;
                showLoading(false);
                updateUI(false);
            }
        }

        /**
         * Alterna el estado de reproducción/pausa.
         */
        async function togglePlayPause() {
            if (!currentStation) {
                // Si no hay emisora seleccionada, reproducir la primera por defecto
                playStation(STATIONS[0]);
                return;
            }

            if (isPlaying) {
                // Si está reproduciendo, detener
                audio.pause();
                updateUI(false);
            } else {
                // Si está detenido, intentar reanudar
                try {
                    showLoading(true);
                    await audio.play();
                    // El evento 'playing' actualizará la UI a 'true'
                } catch (error) {
                    console.error("Error al reanudar la reproducción:", error);
                    statusMessage.textContent = `Error al reanudar. Por favor, selecciona la emisora nuevamente.`;
                    showLoading(false);
                    updateUI(false);
                }
            }
        }

        /**
         * Crea y añade los botones de las emisoras al DOM.
         */
        function renderStationButtons() {
            stationListDiv.innerHTML = ''; // Limpiar la lista
            STATIONS.forEach(station => {
                const button = document.createElement('button');
                button.textContent = station.name;
                button.className = 'station-button w-full text-left p-4 bg-gray-700 text-white rounded-lg shadow-md hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50';
                
                // Asignar el evento de clic para reproducir
                button.addEventListener('click', () => {
                    playStation(station);
                });
                
                stationListDiv.appendChild(button);
            });
        }
        
        /**
         * Maneja el cambio del slider de volumen.
         */
        function handleVolumeChange() {
            // Convierte el valor del slider (0-100) a un valor de volumen de audio (0.0-1.0)
            const volumeValue = volumeRange.value / 100;
            audio.volume = volumeValue;
            volumeDisplay.textContent = `${volumeRange.value}%`;
            // Guardar la última configuración de volumen
            localStorage.setItem('radioVolume', volumeRange.value);
        }
        
        /**
         * Maneja la carga y reproducción de una URL de stream personalizada.
         */
        function loadCustomUrl() {
            const url = customUrlInput.value.trim();
            if (!url) {
                statusMessage.textContent = 'Por favor, introduce una URL válida.';
                showLoading(false);
                return;
            }
            
            const customStation = { 
                name: "Stream Personalizado", 
                url: url 
            };
            
            // Si la URL es la misma, solo hacemos toggle
            if (currentStation && currentStation.url === url) {
                togglePlayPause();
            } else {
                playStation(customStation);
            }
        }

        // --- Manejo de Eventos de Audio (Retroalimentación al Usuario) ---
        
        // Manejo de errores de red o del decodificador
        audio.addEventListener('error', (e) => {
            console.error('Error de audio:', e);
            showLoading(false);
            let errorMsg = 'URL no válida, problema de CORS o red lenta.';
            if (audio.networkState === audio.NETWORK_NO_SOURCE) {
                errorMsg = 'No se encontró el stream (URL no válida).';
            } else if (audio.networkState === audio.NETWORK_LOADING) {
                 errorMsg = 'Error de conexión de red o timeout.';
            }

            statusMessage.textContent = `Error de conexión: ${errorMsg}`;
            updateUI(false);
        });

        // Evento que indica que la reproducción ha comenzado
        audio.addEventListener('playing', () => {
            updateUI(true);
        });
        
        // Evento que indica que la reproducción se ha detenido
        audio.addEventListener('pause', () => {
            updateUI(false);
        });

        // Evento para mostrar 'Bufferizando...'
        audio.addEventListener('waiting', () => {
            if (isPlaying) {
                showLoading(true);
                statusMessage.textContent = '';
            }
        });
        
        // --- Inicialización ---

        function initializeApp() {
            // 1. Cargar el volumen guardado o establecer el predeterminado (70%)
            const savedVolume = localStorage.getItem('radioVolume');
            const initialVolume = savedVolume ? parseInt(savedVolume) : 70;
            
            volumeRange.value = initialVolume;
            audio.volume = initialVolume / 100;
            volumeDisplay.textContent = `${initialVolume}%`;
            
            // 2. Asignar eventos
            playPauseButton.addEventListener('click', togglePlayPause);
            volumeRange.addEventListener('input', handleVolumeChange);
            loadCustomUrlButton.addEventListener('click', loadCustomUrl);
            
            // Permitir cargar URL personalizada presionando Enter en el campo
            customUrlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    loadCustomUrl();
                }
            });

            // 3. Renderizar botones de emisoras
            renderStationButtons();

            // 4. REGISTRO DEL SERVICE WORKER (CRÍTICO PARA LA INSTALACIÓN DE PWA)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registrado con éxito:', reg.scope))
                    .catch(err => console.error('Error al registrar Service Worker:', err));
            }
        }
        
        window.onload = initializeApp;
    </script>
</body>
</html>